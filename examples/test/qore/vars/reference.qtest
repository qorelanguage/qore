#!/usr/bin/env qore
# -*- mode: qore; indent-tabs-mode: nil -*-

%new-style
%enable-all-warnings
%require-types
%strict-args

%requires ../../../../qlib/QUnit.qm

%exec-class ReferenceTest

class ReferenceTest inherits QUnit::Test {
    constructor () : Test("Hash test", "1.0") {
        addTestCase("Reference test", \testReference());

        # Return for compatibility with test harness that checks return value.
        set_return_value(main());
    }

    testReference() {
        {
            int i = 0;
            reference r1 = \i;
            assertEq(0, r1);
            reference r2 = \r1;
            r2 = 1;
            assertEq(1, r1);
            assertEq(1, r2);
            assertEq(1, i);
        }

        list l = (
            ("val": 1),
            ("val", 2),
        );
        reference r1;
        reference r2;
        r1 = \l[0];
        r2 = \l[1];
        r1.val = 10;
        r2.val = 20;
        assertEq(10, l[0].val);
        assertEq(20, l[1].val);
        assertEq(10, r1.val);
        assertEq(20, r2.val);
        r2 = r1;
        assertEq(10, l[0].val);
        assertEq(10, l[1].val);
        assertThrows("REFERENCE-ERROR", sub () { r2 = \r1; });
        reference r3 = \r1;
        assertThrows("REFERENCE-ERROR", sub () { r2 = \r3; });
        reference r4 = \r3;
        assertThrows("REFERENCE-ERROR", sub () { r2 = \r4; });

	{
	    Program p(PO_NEW_STYLE);
	    p.parse("sub t(*reference r) {}", "");
	    assertThrows("RUNTIME-OVERLOAD-ERROR", \p.callFunction(), ("t", {}));
	}
   }
}
