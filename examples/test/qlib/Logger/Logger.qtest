#!/usr/bin/env qore
# -*- mode: qore; indent-tabs-mode: nil -*-

%require-types
%enable-all-warnings
%new-style
%strict-args

%requires ../../../../qlib/QUnit.qm
%requires ../../../../qlib/Logger.qm

%exec-class Test

class Test inherits QUnit::Test {
    private {
        Counter m_counter();
    }
    public {
    }

    constructor() : QUnit::Test("Logger", "1.0", \ARGV) {
        addTestCase("LoggerLevel", \testLoggerLevel());
        addTestCase("LoggerLoggingEvent", \testLoggerLoggingEvent());
        addTestCase("LoggerLayout", \testLoggerLayout());
        addTestCase("LoggerFilter", \testLoggerFilter());
        addTestCase("LoggerAppender", \testLoggerAppender());
        addTestCase("LoggerAppenderMultiThread", \testLoggerAppenderMultiThread());
        addTestCase("Logger", \testLogger());
        set_return_value(main());
    }

    testLoggerLevel() {
        hash lls = (
            'ALL':   LoggerLevel::ALL,
            'TRACE': LoggerLevel::TRACE,
            'DEBUG': LoggerLevel::DEBUG,
            'INFO':  LoggerLevel::INFO,
            'WARN':  LoggerLevel::WARN,
            'ERROR': LoggerLevel::ERROR,
            'FATAL': LoggerLevel::FATAL,
            'OFF':   LoggerLevel::OFF,
        );
        assertEq(LoggerLevel::getLevelAll().getStr(), 'ALL');
        assertEq(LoggerLevel::getLevelTrace().getStr(), 'TRACE');
        assertEq(LoggerLevel::getLevelDebug().getStr(), 'DEBUG');
        assertEq(LoggerLevel::getLevelInfo().getStr(), 'INFO');
        assertEq(LoggerLevel::getLevelWarn().getStr(), 'WARN');
        assertEq(LoggerLevel::getLevelError().getStr(), 'ERROR');
        assertEq(LoggerLevel::getLevelFatal().getStr(), 'FATAL');
        assertEq(LoggerLevel::getLevelOff().getStr(), 'OFF');
        LoggerLevel l1 = LoggerLevel::getLevelFatal();
        LoggerLevel l2 = LoggerLevel::getLevelError();
        assertTrue(l1.isGreaterOrEqual(l2));
        assertTrue(l1.isEqual(LoggerLevel::getLevelFatal()));
        assertTrue(l1.isEqual(l1));
        assertFalse(l1.isEqual(l2));

        foreach string s in (keys lls) {
            LoggerLevel ll1 = LoggerLevel::getLevel(s);
            assertEq(ll1.getValue(), lls{s});
            assertEq(ll1.getStr(), s);
            LoggerLevel ll2 = LoggerLevel::getLevel(lls{s});
            assertEq(ll2.getValue(), lls{s});
            assertEq(ll2.getStr(), s);
            assertTrue(ll1.isEqual(ll2));
            assertTrue(ll1.isGreaterOrEqual(ll2));
        }

    }

    testLoggerLoggingEvent() {
        LoggerLoggingEvent lle;
        date ts = LoggerLoggingEvent::getStartTime() + 1D;
        lle = new LoggerLoggingEvent('fqcn', 'ctg', LoggerLevel::getLevelError(), 'test: %d, %d', (1, 2), NOTHING, gettid(), ts, NOTHING);
        assertEq(lle.getFullQualifiedClassname(), 'fqcn');
        assertEq(lle.getCategoryName(), 'ctg');
        assertTrue(lle.getLevel().isEqual(LoggerLevel::getLevelError()));
        assertEq(lle.getMessage(), 'test: 1, 2');
        assertEq(lle.getThreadId(), gettid());
        assertEq(lle.getTimeStamp(), ts);
        assertEq(lle.getRelativeTime(), 1D);

        Logger l('testLogger');
        lle = new LoggerLoggingEvent(l, LoggerLevel::getLevelError(), 'test: %d, %d');
        assertEq(lle.getFullQualifiedClassname(), get_class_name(l));
        assertEq(lle.getCategoryName(), 'testLogger');
        assertEq(lle.getLogger(), l);
    }

    testLoggerLayout() {
        LoggerLayoutPattern llp("");
        hash<CallStackInfo> csi();
        csi.file = "testfile";
        csi.source = "testsource";
        csi.line = 987;
        csi.function = "myfunction";
        hash<ExceptionInfo> ei();
        try {
            throw "TEST-ERROR", "Test exception";
        } catch (hash<ExceptionInfo> ex) {
            ei = ex;
        }
        LoggerLoggingEvent::setStartTime(2000-01-01T00:00:00);
        date ts = LoggerLoggingEvent::getStartTime() + 1D;
        LoggerLoggingEvent lle = new LoggerLoggingEvent('A.B.C.Logger', 'a.b.c.d', LoggerLevel::getLevelError(), 'ABCDEF', (), csi, 123, ts, ei);
        hash patterns = (
            "": (
                "parsed": (),
                "output": "",
            ),
            "ABC": (
                "parsed": ("ABC",),
                "output": "ABC",
            ),
            "%%": (
                "parsed": ("%",),
                "output": "%",
            ),
            "%%%%%%": (
                "parsed": ("%%%",),
                "output": "%%%",
            ),
            "ABC%%": (
                "parsed": ("ABC%",),
                "output": "ABC%",
            ),
            "%%ABC": (
                "parsed": ("%ABC",),
                "output": "%ABC",
            ),
            "ABC%%D": (
                "parsed": ("ABC%D",),
                "output": "ABC%D",
            ),
            "%m": (
                "parsed": (("key": "m"),),
                "output": "ABCDEF",
            ),
            "%Z": (
                "parsed": (("key": "Z"),),
                "output": "N/A",
            ),
            "%m{DUMMY}": (
                "parsed": ((
                    "key": "m",
                    "option": "DUMMY",
                ),),
                "output": "ABCDEF",
            ),
            "%5m{DUMMY}": (
                "parsed": ((
                    "key": "m",
                    "minWidth": 5,
                    "leftJustify": False,
                    "option": "DUMMY",
                ),),
                "output": "ABCDEF",
            ),
            "%10m{DUMMY}": (
                "parsed": ((
                    "key": "m",
                    "minWidth": 10,
                    "leftJustify": False,
                    "option": "DUMMY",
                ),),
                "output": "    ABCDEF",
            ),
            "%-10m{DUMMY}": (
                "parsed": ((
                    "key": "m",
                    "minWidth": 10,
                    "leftJustify": True,
                    "option": "DUMMY",
                ),),
                "output": "ABCDEF    ",
            ),
            "%.3m{DUMMY}": (
                "parsed": ((
                    "key": "m",
                    "maxWidth": 3,
                    "option": "DUMMY",
                ),),
                "output": "ABC",
            ),
            "%.10m{DUMMY}": (
                "parsed": ((
                    "key": "m",
                    "maxWidth": 10,
                    "option": "DUMMY",
                ),),
                "output": "ABCDEF",
            ),
            "%10.10m{DUMMY}": (
                "parsed": ((
                    "key": "m",
                    "minWidth": 10,
                    "maxWidth": 10,
                    "leftJustify": False,
                    "option": "DUMMY",
                ),),
                "output": "    ABCDEF",
            ),
            "%-10.10m{DUMMY}": (
                "parsed": ((
                    "key": "m",
                    "minWidth": 10,
                    "maxWidth": 10,
                    "leftJustify": True,
                    "option": "DUMMY",
                ),),
                "output": "ABCDEF    ",
            ),
            "%%%m%%": (
                "parsed": (
                    "%",
                    (
                        "key": "m",
                    ),
                    "%"
                ),
                "output": "%ABCDEF%",
            ),
            "%d": (
                "parsed": (("key": "d"),),
                "output": format_date(LoggerLayoutPattern::DEFAULT_DATE_FORMAT, lle.getTimeStamp()),
            ),
            "%F:%L %M": (
                "parsed": (
                    ("key": "F"),
                    ":",
                    ("key": "L"),
                    " ",
                    ("key": "M"),
                ),
                "output": csi.file+":"+string(csi.line)+" "+csi.function,
            ),
            "%d{DD.MM.YYYY HH:mm:SS}": (
                "parsed": (("key": "d", "option": "DD.MM.YYYY HH:mm:SS"),),
                "output": format_date("DD.MM.YYYY HH:mm:SS", lle.getTimeStamp()),
            ),

            "%c{1} %c{XXX} %C{2}%n": (
                "parsed": (
                    ("key": "c", "option": "1"),
                    " ",
                    ("key": "c", "option": "XXX"),
                    " ",
                    ("key": "C", "option": "2"),
                    ("key": "n"),
                ),
                "output": "d a.b.c.d C.Logger" + LoggerLayoutPattern::getLineDelimiter(),
            ),

            "%r [%t] %p %c - %m%n": (
                "parsed": (
                    ("key": "r"),
                    " [",
                    ("key": "t"),
                    "] ",
                    ("key": "p"),
                    " ",
                    ("key": "c"),
                    " - ",
                    ("key": "m"),
                    ("key": "n"),
                ),
                "output": "86400000 [123] ERROR a.b.c.d - ABCDEF"+LoggerLayoutPattern::getLineDelimiter(),
            ),
        );
        foreach string patt in (keys patterns) {
            llp.setPattern(patt);
            assertEq(patt, llp.getPattern());
            assertEq(patterns{patt}.parsed, llp.getParsedPattern());
            assertEq(patterns{patt}.output, llp.format(lle));
        }

        llp.setPattern("%x");
        assertTrue(exists lle.getThrowableInfo());
        assertRegex("TEST-ERROR: Test exception", llp.format(lle));

        hash patternsErr = (
            "%/AAA": "Wrong pattern starting %/AAA",
            "%0-9c": "Wrong pattern option starting %0-9c",
            "%%%": "Wrong pattern starting %",
        );
        foreach string patt in (keys patternsErr) {
            assertThrows("LOGGER-ERROR", patternsErr{patt}, \llp.setPattern(), (patt));
        }
    }

    testLoggerFilter() {
        hash<CallStackInfo> csi();
        csi.file = "testfile";
        csi.source = "testsource";
        csi.line = 987;
        csi.function = "myfunction";
        LoggerLoggingEvent lle = new LoggerLoggingEvent('A.B.C.Logger', 'a.b.c.d', LoggerLevel::getLevelError(), 'ABCDEF', (), csi, 123);
        LoggerFilterLevel lfl(); # INFO-OFF
        # max > min
        assertEq(LoggerLevel::getLevelInfo(), lfl.getMinLevel());
        assertEq(LoggerLevel::getLevelOff(), lfl.getMaxLevel());
        assertEq(LoggerFilter::NEUTRAL, lfl.eval(lle));
        lfl.setMinLevel(LoggerLevel::getLevelFatal());
        assertEq(LoggerFilter::DENY, lfl.eval(lle));
        lfl.setMinLevel(LoggerLevel::ERROR);
        assertEq(LoggerLevel::getLevelError(), lfl.getMinLevel());
        assertEq(LoggerFilter::NEUTRAL, lfl.eval(lle));
        lfl.setMaxLevel("ERROR");
        assertEq(LoggerLevel::getLevelError(), lfl.getMaxLevel());
        assertEq(LoggerFilter::NEUTRAL, lfl.eval(lle));
        lfl.setMinLevel("DEBUG");
        assertEq(LoggerLevel::getLevelDebug(), lfl.getMinLevel());
        assertEq(LoggerFilter::NEUTRAL, lfl.eval(lle));
        lfl.setMaxLevel(LoggerLevel::INFO);
        assertEq(LoggerLevel::getLevelInfo(), lfl.getMaxLevel());
        assertEq(LoggerFilter::DENY, lfl.eval(lle));
        # max < min
        lfl.setMaxLevel("DEBUG");
        lfl.setMinLevel("ERROR");
        assertEq(LoggerFilter::DENY, lfl.eval(lle));
        lfl.setMinLevel("INFO");
        assertEq(LoggerFilter::NEUTRAL, lfl.eval(lle));
        lfl.setMinLevel("OFF");
        lfl.setMaxLevel("ERROR");
        assertEq(LoggerFilter::DENY, lfl.eval(lle));
        lfl.setMaxLevel("FATAL");
        assertEq(LoggerFilter::NEUTRAL, lfl.eval(lle));

        LoggerFilterRegex lfr("^A", True);
        assertEq("^A", lfr.getRegex());
        assertTrue(lfr.getRegexResult());
        assertEq(LoggerFilter::NEUTRAL, lfr.eval(lle));
        lfr.setRegex("^A", False);
        assertFalse(lfr.getRegexResult());
        assertEq(LoggerFilter::DENY, lfr.eval(lle));
        lfr.setRegex("^B", False);
        assertEq("^B", lfr.getRegex());
        assertFalse(lfr.getRegexResult());
        assertEq(LoggerFilter::NEUTRAL, lfr.eval(lle));
        lfr.setRegex("^B", True);
        assertEq(LoggerFilter::DENY, lfr.eval(lle));

    }

    testLoggerAppender() {
        LoggerLayoutPattern llp("");
        llp.setPattern("%m");
        StringOutputStream sos();
        StreamWriter sw(sos);
        LoggerAppenderStream la("TEST", llp, sw);
        LoggerFilterLevel lfl(LoggerLevel::ERROR);
        LoggerFilterRegex lfr("^A");
        LoggerFilterRegex lfr2("DUMMY");
        LoggerLoggingEvent lle = new LoggerLoggingEvent('A.B.C.Logger', 'a.b.c.d', LoggerLevel::getLevelError(), 'ABCDEF');
        assertEq("TEST", la.getName());
        assertFalse(la.isActive());
        assertEq(llp, la.getLayout());
        LoggerAppenderQueue laq = new LoggerAppenderQueue();
        la.setQueue(laq);
        assertEq(laq, la.getQueue());
        la.open();
        assertThrows("LOGGER-ERROR", "Appender is opened", \la.setQueue(), (laq,));
        assertTrue(la.isActive());
        la.post(lle);
        assertEq("ABCDEF", sos.getData());

        # filter list test
        assertEq((), la.getFilters());
        la.addFilter(lfl);
        assertEq((lfl, ), la.getFilters());
        la.removeFilter(lfl);
        assertEq((), la.getFilters());
        la.addFilter(lfl);
        la.addFilter(lfr);
        assertEq((lfl, lfr), la.getFilters());
        assertThrows("LOGGER-ERROR", "Filter already exists in list", \la.addFilter(), (lfr));
        la.addFilter(lfr2, True);
        assertEq((lfr2, lfl, lfr), la.getFilters());
        la.removeFilter(lfl);
        assertEq((lfr2, lfr), la.getFilters());
        la.removeAllFilters();
        assertEq((), la.getFilters());
        la.addFilter(lfl);
        la.addFilter(lfr);
        la.post(lle);
        assertEq("ABCDEF", sos.getData());
        lfr.setRegex("^B");
        la.post(lle);
        assertEq("", sos.getData());
        la.removeFilter(lfr);
        assertEq((lfl, ), la.getFilters());
        la.post(lle);
        assertEq("ABCDEF", sos.getData());
    }

    startPostThread(LoggerAppender la) {
        try {
            assertTrue(la.post(new LoggerLoggingEvent('A.B.C.Logger', 'a.b.c.d', LoggerLevel::getLevelError(), 'ABCDEF')));
        } catch (hash ex) {
            printf("Ex: %y\n", ex);
        }
        m_counter.dec();
    }

    startProcessThread(LoggerAppenderStream la) {
        StringOutputStream sos = la.getStreamWriter().getOutputStream();
        try {
            int n = la.getQueue().size();
            sos.reassignThread();
            la.getQueue().process();
            assertEq(n, sos.getData().split(",").size());
        } catch (hash<ExceptionInfo> ex) {
            printf("Ex: %y\n", ex);
        }
        sos.unassignThread();
        m_counter.dec();
    }

    testLoggerAppenderMultiThread() {
        LoggerLayoutPattern llp("");
        llp.setPattern("%m[%t]");
        StringOutputStream sos();
        StreamWriter sw(sos);
        LoggerAppenderStream la("TEST", llp, sw);
        la.open();

        m_counter.inc();
        int tid = background startPostThread(la);
        m_counter.waitForZero();
        la.getQueue().process();
        assertEq(sprintf("ABCDEF[%d]", tid), sos.getData());

        llp.setPattern("%t,");
        int n = 200;
        list tids = ();
        while (n > 0) {
            m_counter.inc();
            push tids, background startPostThread(la);
            n--;
        }
        while (m_counter.getCount() > 0) {
            la.getQueue().process();
        }
        m_counter.waitForZero();
        list l2 = ();
        string ls = sos.getData();

        map (push l2, int($1)), (select ls.split(","), $1 != "");
        tids = sort(tids, int sub(int l, int h) {return l<=>h;});
        l2 = sort(l2, int sub(int l, int h) {return l<=>h;});
        assertEq(tids, l2);

        llp.setPattern("%m,");
        n = 200;
        while (n > 0) {
            m_counter.inc();
            push tids, background startPostThread(la);
            n--;
        }
        m_counter.waitForZero();
        m_counter.inc();
        sos.unassignThread();
        background startProcessThread(la);
        m_counter.waitForZero();
        sos.reassignThread();  # for close()
    }

    testLogger() {
        Logger l1("TEST");
        LoggerRoot l2(LoggerLevel::getLevelError());
        assertEq("TEST", l1.getName());
        # parent test
        assertEq(NOTHING, l1.getParent());
        l1.setParent(l2);
        assertEq(l2, l1.getParent());
        assertEq(NOTHING, l2.getParent());
        l1.setParent(NOTHING);
        assertEq(NOTHING, l1.getParent());
        l1.setParent(l2);
        assertEq(l2, l1.getParent());

        assertThrows("LOGGER-ERROR", "Circular logger chain", \l1.setParent(), (l1));
        assertEq(l2, l1.getParent());
        assertThrows("LOGGER-ERROR", "Cannot set parent for root", \l2.setParent(), (l1));
        assertThrows("LOGGER-ERROR", "Cannot set null level for root", \l2.setLevel());

        # level test
        assertEq(NOTHING, l1.getLevel(False));
        assertEq(LoggerLevel::getLevelError(), l2.getLevel(False));
        assertEq(LoggerLevel::getLevelError(), l1.getLevel());
        assertEq(True, l1.isEnabledFor(LoggerLevel::ERROR));
        assertEq(True, l1.isErrorEnabled());
        assertEq(False, l1.isEnabledFor(LoggerLevel::getLevelDebug()));
        assertEq(False, l1.isDebugEnabled());
        assertEq(True, l1.isEnabledFor("FATAL"));
        assertEq(True, l1.isFatalEnabled());
        l1.setLevel("FATAL");
        assertEq(LoggerLevel::getLevelFatal(), l1.getLevel());
        l1.setLevel(LoggerLevel::ALL);
        assertEq(LoggerLevel::getLevelAll(), l1.getLevel());
        l1.setLevel(NOTHING);
        assertEq(LoggerLevel::getLevelError(), l1.getLevel());

        l1.setParent(NOTHING);
        assertThrows("LOGGER-ERROR", "Cannot get effective level", \l1.getLevel());
        l1.setParent(l2);

        # additivity test
        assertEq(True, l1.getAdditivity());
        l1.setAdditivity(False);
        assertEq(False, l1.getAdditivity());
        l1.setAdditivity(True);
        assertEq(True, l1.getAdditivity());

        # arrange appenders
        LoggerLayoutPattern llp("%c{1}/%m");
        StringOutputStream sos1();
        StreamWriter sw1(sos1);
        LoggerAppenderStream la1("TEST", llp, sw1);

        StringOutputStream sos2();
        StreamWriter sw2(sos2);
        LoggerAppenderStream la2("ALERT", llp, sw2);
        LoggerFilterLevel lfl(LoggerLevel::FATAL);
        la2.addFilter(lfl);

        StringOutputStream sos3();
        StreamWriter sw3(sos3);
        LoggerAppenderStream la3("ROOT", llp, sw3);

        # appender list test
        assertEq((), l1.getAppenders());
        l1.addAppender(la1);
        assertEq((la1, ), l1.getAppenders());
        l1.removeAppender(la1);
        assertEq((), l1.getAppenders());
        l1.addAppender(la1);
        l1.addAppender(la2);
        assertEq((la1, la2), l1.getAppenders());
        assertThrows("LOGGER-ERROR", "Appender already exists in list", \l1.addAppender(), (la1));
        l1.addAppender(la3);
        assertEq((la1, la2, la3), l1.getAppenders());
        l1.removeAppender(la2);
        assertEq((la1, la3), l1.getAppenders());
        l1.removeAllAppenders();
        assertEq((), l1.getAppenders());

        l1.setAdditivity(True);
        l1.setLevel("DEBUG");
        l1.addAppender(la1);
        l1.addAppender(la2);
        l2.addAppender(la3);
        la1.open();
        la2.open();
        la3.open();
        # sos1 ... DEBUG
        # sos2 ... FATAL
        # sos3 ... ERROR

        l1.error("test");
        assertEq("TEST/test", sos1.getData());
        assertEq("", sos2.getData());
        assertEq("/test", sos3.getData());
        l1.setAdditivity(False);
        l1.log("ERROR", "test");
        assertEq("TEST/test", sos1.getData());
        assertEq("", sos2.getData());
        assertEq("", sos3.getData());
        l1.setAdditivity(True);
        l2.log(LoggerLevel::ERROR, "test");
        assertEq("", sos1.getData());
        assertEq("", sos2.getData());
        assertEq("/test", sos3.getData());

        l1.trace("test");
        assertEq("", sos1.getData());
        assertEq("", sos2.getData());
        assertEq("", sos3.getData());

        l1.log(LoggerLevel::getLevelDebug(), "test");
        assertEq("TEST/test", sos1.getData());
        assertEq("", sos2.getData());
        assertEq("", sos3.getData());

        l1.log(LoggerLevel::FATAL, "test");
        assertEq("TEST/test", sos1.getData());
        assertEq("TEST/test", sos2.getData());
        assertEq("/test", sos3.getData());

        l1.assertLog(False, "test: %d,%s", 1, "a");
        assertEq("TEST/test: 1,a", sos1.getData());
        assertEq("", sos2.getData());
        assertEq("/test: 1,a", sos3.getData());

        int i = 124;
        l1.debugVar("i", i);
        assertEq("TEST/i: 124", sos1.getData());

        llp.setPattern("%F:%L");
        l1.error("ERROR", "test");
        hash<CallStackInfo> loc = get_thread_call_stack()[0];

        assertEq(sprintf("%s:%d", loc.file, loc.line-1), sos1.getData());
    }

}
